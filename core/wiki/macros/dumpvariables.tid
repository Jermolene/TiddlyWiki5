title: $:/core/macros/dumpvariables
tags: $:/tags/Global

\whitespace trim

<!-- CONST string definitions -->
\procedure DV-VAR-FILTER-OPTIONS() all fn var proc macro widget
\procedure DV-FILTER-OPTIONS() $:/temp/varSearch/options
\procedure DV-SORT-OPTIONS() $:/temp/varSearch/sort

<!-- Filter strings selected by "Sort" dropdown -->
\procedure DV-RAW-FILTER-STR() [variables:raw<_tf.dv-type>]
\procedure DV-FILTER-STR() [variables<_tf.dv-type>]

<!-- State or temp variable base-names -->
\procedure DV-FOLDED() $:/temp/varFolded
\procedure DV-SEARCH() $:/temp/varSearch
\procedure DV-SEARCH-DETAILS() $:/temp/varSearch/details
\procedure DV-SEARCH-STATE() $:/state/varSearch/name
\procedure DV-EXCLUDE() $:/state/varExclude
\procedure DV-TYPE-STATE() $:/state/typeState

<!-- Construct filter strings -->
\function tf.dv-filterString() [<_tf.dv-sort>match[raw]then<DV-RAW-FILTER-STR>else<DV-FILTER-STR>]
\function tf.dv-formattedVar() [<varname>format:variable<_tf.dv-varFormatStr>]

\function tf.dv-foldedState() [<DV-FOLDED>] [<qualify>] +[join[/]]

<!-- ============================ -->
<!-- dumpvariables main procedure -->
<!-- ============================ -->
\procedure dumpvariables(type sort subfilter:"[[]]" format)

<!-- The following function is needed since the "format" string can contain closing brackets ")" -->
<!-- Be aware that the "format" filter operator uses $var-name$ for compatibility reasons -->
\function _tf.dv-varFormatStr() [<format>!is[blank]then<format>else[$type$ $name$($params$)]]
\function _tf.dv-type() [<type>]
\function _tf.dv-sort() [<sort>]
<ul>
	<$list filter="[subfilter<tf.dv-filterString>] +[filter<subfilter>]" variable="varname">
		<li>
			<code><$text text=<<tf.dv-formattedVar>>/></code><br/>
			<% if [<tf.dv-formattedVar>prefix[\function]] %>
				<$codeblock code={{{ [<varname>getvariable[value]] }}}/>
			<% endif %>
			<$codeblock code={{{ [<varname>getvariable[]] }}}/>
		</li>
	</$list>
</ul>
\end

<!-- search-variables helper functions -->
\procedure dv-toggleState()
<$action-setfield $tiddler=<<tf.dv-varState>> text={{{ [<tf.dv-varState>get[text]] +[toggle[yes],[no]] }}}/>
\end

\procedure dv-toggleInfoState()
<$action-setfield $tiddler=<<tf.dv-toggleInfoState>>
	text={{{ [<tf.dv-toggleInfoState>get[text]] +[toggle[yes],[no]] }}}
/>
<!-- Existing user modified "search text details" should be preserved. If empty use default formatted signature -->
<!-- Be aware that the "format" filter operator uses $var-name$ for compatibility reasons -->
<$action-setfield $tiddler=<<tf.dv-detailsSearch>>
	text={{{ [<tf.dv-getDetailsSearchText>!is[blank]then<tf.dv-getDetailsSearchText>] :else[<varname>format:variable[$type$ $name$($params$)]] }}}
>
<$action-log $$filter="[prefix[tf.]]"/>
</$action-setfield>
\end

\procedure dv-clearStatesButton()
<span class="tc-small-gap">{{$:/language/Search/Variables/FoldAll}}</span>
<$button class="tc-btn-invisible tc-tiny-gap-left">
	<!-- "search text details" should be preserved -->
	<$action-deletetiddler $filter="[prefix<DV-SEARCH-STATE>]"/>
	{{$:/core/images/fold-all-button}}
</$button>
\end

\procedure dv-clearSearchButton()
<$button class="tc-btn-invisible btn-x"
	tooltip=`${ [{$:/language/Search/Variables/Clear}] [{$:/language/Search/Variables/Filter}] +[join[ ]] }$`
>
	<$action-deletetiddler $tiddler=<<tf.dv-searchText>>/>
	{{$:/core/images/close-button}}
</$button>
\end

\procedure dv-clearExcludeButton()
<$button class="tc-btn-invisible btn-yy"
	tooltip=`${ [{$:/language/Search/Variables/Clear}] [{$:/language/Search/Variables/Exclude}] +[join[ ]] }$`
>
	<$action-deletetiddler $tiddler=<<tf.dv-excludeText>>/>
	{{$:/core/images/close-button}}
</$button>
\end

\procedure dv-expandAllStatesButton()
<span class="tc-tiny-gap">{{$:/language/Search/Variables/ExpandAll}}</span>
<$button class="tc-btn-invisible">
	<$action-setfield $tiddler=<<DV-SEARCH-STATE>>
		text={{{ [<tf.dv-toggleInfoState>get[text]] +[toggle[yes],[no]] }}}
	/>
	<!-- only expand currently visible elements -->
	<$list filter="[subfilter<tf.dv-filterString>] +[search::some<tf.dv-getSearchText>] +[filter<subfilter>]"
		variable="varname"
	>
		<$action-setfield $tiddler=<<tf.dv-varState>> text="yes"/>
	</$list>
	{{$:/core/images/unfold-all-button}}
</$button>
\end

\procedure dv-info()
<div class="multi-columns">
	<$list filter="[all[tiddlers+shadows]] :filter[search:text,tags:words<tf.dv-getDetailsSearchText>] 
		-[[$:/config/OriginalTiddlerPaths]]
		-[[$:/HistoryList]]
		-[[$:/StoryList]]
		-[[$:/core]]
		:filter[!type[application/javascript]]
		:filter[!prefix[$:/temp/]]
		:filter[!prefix[$:/state/]]
		:filter[!plugin-type[plugin]]"
	>
		<$link class="tc-small-gap-left"/><br>
	</$list>
</div>
\end

<!-- \procedure dv-filterOptions()
<style>
.tc-dv-filterOptions [data-gap="right"] {
	width: auto;
	margin-right: .25em;
}
</style>
<span class="tc-dv-filterOptions tc-small-gap-right">
{{$:/language/Search/Variables/Option/Type}}
<$list filter="[enlist<DV-VAR-FILTER-OPTIONS>]" variable="option">
	<$checkbox tiddler=<<tf.dv-tmpTypeOptions>> listField="text" checked=<<option>>
		class="tc-small-gap-left tc-small-gap-right" data-gap="right"
	>
		<<option>>
	</$checkbox>
</$list>|
</span>
\end

\procedure dv-sortOptions()
<span class="tc-dv-sortOptions">
	{{$:/language/Search/Variables/Option/Sort}}
	<$select tiddler=<<tf.dv-tmpSortOptions>> default="alphabetical" class="tc-tiny-gap-left">
		<option value="alphabetical">alphabetical</option>
		<option value="raw">raw</option>
	</$select>
</span>
\end -->

\function tf.dv-tmpTypeOptions() [<DV-FILTER-OPTIONS>] [<qualify>] +[join[/]]
\function tf.dv-tmpSortOptions() [<DV-SORT-OPTIONS>] [<qualify>] +[join[/]]

\function tf.dv-searchText() [<DV-SEARCH>] [<qualify>] +[join[/]]
\function tf.dv-getSearchText() [<tf.dv-searchText>get[text]]

\function tf.dv-excludeText() [<DV-EXCLUDE>] [<qualify>] +[join[/]]
\function tf.dv-getExcludeText() [<tf.dv-excludeText>get[text]]

\function tf.dv-detailsSearch() [<DV-SEARCH-DETAILS>] [<varname>] [<qualify>] +[join[/]]
\function tf.dv-getDetailsSearchText() [<tf.dv-detailsSearch>get[text]]

\function tf.dv-varState() [<DV-SEARCH-STATE>] [<varname>] [<qualify>] +[join[/]]
\function tf.dv-toggleInfoState() [<DV-SEARCH-STATE>] [<varname>] +[join[/]]

<!-- =============================== -->
<!-- search-variables main procedure -->
<!-- =============================== -->
\procedure search-variables(type sort subfilter:"[[]]" format)

<!-- The following function is needed since the "format" string can contain closing brackets ")" -->
<!-- Be aware that the "format" filter operator uses $var-name$ for compatibility reasons -->
\function _tf.dv-varFormatStr() [<format>!is[blank]then<format>else[$type$ $name$($params$)]]
\function _tf.dv-type() [<type>!is[blank]then<type>] :else[<tf.dv-tmpTypeOptions>get[text]]
\function _tf.dv-sort() [<sort>!is[blank]then<sort>] :else[<tf.dv-tmpSortOptions>get[text]] :else[[alphabetical]]

<<dv-searchForm>>

<$list filter="[subfilter<tf.dv-filterString>] 
		+[search::some<tf.dv-getSearchText>]
		+[filter<subfilter>]
		+[!filter<tf.dv-getExcludeText>]"
	variable="varname"
>
	<div class="tc-var-item">
		<$button actions=<<dv-toggleState>> class="tc-small-gap-left tc-btn-invisible">
			<% if [<tf.dv-varState>get[text]match[yes]] %>
				{{$:/core/images/down-arrow}}
			<% else %>
				{{$:/core/images/right-arrow}}
			<% endif %>
			<code class="tc-small-gap-right"><$text text=<<tf.dv-formattedVar>>/></code>
			<% if [<tf.dv-formattedVar>prefix[\function]] %>
				<!-- Be aware that the "format" filter operator uses $var-name$ for compatibility reasons -->
				<span class="tc-tiny-gap-right"><$text text={{{ [<varname>format:variable[$firstLine$]] }}}/></span>
			<% endif %>
		</$button>

		<% if [<tf.dv-varState>get[text]match[yes]] %>
			<$button actions=<<dv-toggleInfoState>> class="tc-btn-invisible tc-small-gap-left">
				<% if [<tf.dv-toggleInfoState>get[text]match[yes]] %>
					{{$:/core/images/up-arrow}}
				<% else %>
					{{$:/core/images/advanced-search-button}}
				<% endif %>
			</$button>
			<blockquote class="tc-quote">
				<% if [<tf.dv-toggleInfoState>get[text]match[yes]] %>
					<div class="tc-labeled-input-wrapper">
						<span class="tc-fixed-label tc-align-right">{{$:/language/Search/Variables/Search/Details}}</span>
						<$edit-text tiddler=<<tf.dv-detailsSearch>> tag=input class="tc-fluid-input tc-small-gap-left"/>
					</div>
					<<dv-info>>
				<% endif %>
				<% if [<varname>prefix[\function]] %>
					<$codeblock code={{{ [<varname>getvariable[value]] }}}/>
				<% endif %>
				<$codeblock code={{{ [<varname>getvariable[]] }}}/>
			</blockquote>
		<% endif %>
	</div>
</$list>
\end


<!-- ================================== -->
<!-- Grid Based Advanced Variables Form -->
<!-- ================================== -->

\procedure dv-search-input-box()
<%if [<sort>!is[blank]] %>
	<code class="tc-small-gap">sort:<<_tf.dv-sort>></code>
<%endif%>
<%if [<type>!is[blank]] %>
	<code class="tc-small-gap">type:<<_tf.dv-type>></code>
<%endif%>
<span class="x-txt"><$text text={{$:/language/Search/Variables/Filter}}/></span>
<$edit-text tiddler=<<tf.dv-searchText>>
	tag=input
	class="txt-input x-inp"
	placeholder={{$:/language/Search/Variables/Filter/Hint}}
/>
<<dv-clearSearchButton>>
\end

\procedure dv-exclude-input-box()
<span class="y-txt"><$text text={{$:/language/Search/Variables/Exclude}}/></span>
<$edit-text tiddler=<<tf.dv-excludeText>>
	tag=input
	class="txt-input y-inp"
	placeholder={{$:/language/Search/Variables/Exclude/Hint}}
/>
<<moreVariablesPopup>>
<% if [<tf.dv-getExcludeText>!is[blank]] %>
	<<dv-clearExcludeButton>>
<% endif %>
\end

\function tf.dv-opt-class() "c" [<option>] +[join[-]] "tc-dv-filterOptions" +[join[ ]]

\procedure dv-filterOptions()
<style>
.tc-dv-filterOptions [data-gap="right"] {
	width: auto;
	margin-right: .25em;
}
</style>
<span class="t-txt">{{$:/language/Search/Variables/Option/Type}}</span>
<$list filter="[enlist<DV-VAR-FILTER-OPTIONS>]" variable="option">
	<%if [<DV-TYPE-STATE>get[text]match[checkbox]] %>
		<$checkbox tiddler=<<tf.dv-tmpTypeOptions>>
			listField="text"
			checked=<<option>>
			default="all"
			class=<<tf.dv-opt-class>>
			data-gap="right"
		>
			<<option>>
		</$checkbox>
	<% else %>
		<$radio tiddler=<<tf.dv-tmpTypeOptions>>
			listField="text" value=<<option>>
			default="all"
			class=<<tf.dv-opt-class>>
			data-gap="right"
		>
			<<option>>
		</$radio>
	<% endif %>
</$list>
\end

\procedure dv-sortOptions()
<span class="sel-txt">
	{{$:/language/Search/Variables/Option/Sort}}
</span>
<$select tiddler=<<tf.dv-tmpSortOptions>>
	default="alphabetical"
	class="sel-drop"
>
	<option value="alphabetical">alphabetical</option>
	<option value="raw">raw</option>
</$select>
\end

\procedure dv-expandFoldOption()
<span class="ex-btn">
<% if [<DV-SEARCH-STATE>get[text]match[yes]] %>
	<<dv-clearStatesButton>>
<% else %>
	<<dv-expandAllStatesButton>>
<% endif %>
</span>
\end

<!-- ========================================== -->
<!-- Main -- Grid Based Advanced Variables Form -->
<!-- ========================================== -->
\procedure dv-searchForm()
<div class="tc-flexible-form">
	<div class="tc-flexible-checkbox-container">
	<<dv-filterOptions>> <<dv-sortOptions>> <<dv-expandFoldOption>>
	</div>
	<div class="tc-flexible-input-container">
		<$reveal stateTitle=<<tf.dv-foldedState>>
			tag="div"
			class=`btn-fld ${[<tf.dv-getExcludeText>!is[blank]then[btn-fld-has-exluded]]}$`
			type="nomatch"
			text="show"
			default="hide"
		>
			<$button tooltip={{$:/language/Search/Variables/Exclude/Show}} class="tc-dv-btn tc-btn-invisible">
				<$action-setfield $tiddler=<<tf.dv-foldedState>> $field=text $value="show"/>
				{{$:/core/images/right-arrow}}
			</$button>
		</$reveal>
		<$reveal stateTitle=<<tf.dv-foldedState>>
			tag="div"
			class=`btn-fld ${[<tf.dv-getExcludeText>!is[blank]then[btn-fld-has-exluded]]}$`
			type="nomatch"
			text="hide"
			default="hide"
			style="align-self: center;"
		>
			<$button tooltip={{$:/language/Search/Variables/Exclude/Hide}}  class="tc-dv-btn tc-btn-invisible">
				<$action-setfield $tiddler=<<tf.dv-foldedState>> $field=text $value="hide"/>
				{{$:/core/images/up-arrow}}
			</$button>
		</$reveal>
		<<dv-search-input-box>>
		<% if [<tf.dv-foldedState>get[text]match[show]] %>
			<<dv-exclude-input-box>>
		<% endif %>
	</div>
</div>
\end


<!-- ==================== -->
<!-- More Variables Popup -->

<!-- TODO Select the focus to right input -->
\procedure dv-lc-actionsXX()
<$action-setfield $tiddler="$:/temp/advancedsearch" text=<<navigateTo>>/>
<$action-setfield $tiddler="$:/temp/advancedsearch/input" text=<<navigateTo>>/>
<$action-setfield $tiddler="$:/temp/advancedsearch/refresh" text="yes"/>
<$action-sendmessage $message="tm-focus-selector" $param=".tc-advanced-search input"/>
\end

\procedure dv-lc-actions()
<$action-setfield $tiddler=<<tf.dv-excludeText>> text=<<navigateTo>>/>
\end

\procedure dv-addNewVariableFilter-actions()
<$action-sendmessage
	$message="tm-new-tiddler"
	tags="$:/tags/Variables/Exclude/Snippet"
	description={{$:/language/Search/Variables/Exclude/Description}}
	text=<<tf.dv-getExcludeText>>
/>

<$action-deletetiddler
	$tiddler=<<dropdown-state>>
/>
\end

\procedure dv-addNewVariableFilter()
<$button tag="a" actions=<<dv-addNewVariableFilter-actions>> class="tc-tiddlylink">
	<em>
		<$text text={{$:/language/Search/Variables/Exclude/Save}}/>
	</em>
</$button>
\end

\procedure moreVariablesPopup()
<span class="tc-popup-keep btn-y">
	<$button popup=<<qualify "$:/state/variableDropdown">> class="tc-btn-invisible">
		{{$:/core/images/down-arrow}}
	</$button>
</span>

<$reveal state=<<qualify "$:/state/variableDropdown">> type="popup" position="belowleft">
	<$let name="tv-show-missing-links" value="yes">
		<$linkcatcher actions=<<dv-lc-actions>> >
			<div class="tc-block-dropdown-wrapper">
				<div class="tc-block-dropdown tc-variables-dropdown">
					<!-- <$macrocall $name="list-tagged-draggable"
						tag="$:/tags/Variables/Exclude/Snippet"
						subFilter="!is[draft]"
						itemTemplate="$:/core/ui/AdvancedSearch/Variables/ItemTemplate"
					/>  --> <!-- TODO make drag & drop sorting possible -->
					<$list filter="[all[shadows+tiddlers]tag[$:/tags/Variables/Exclude/Snippet]!is[draft]]">
						<div>
							{{||$:/core/ui/AdvancedSearch/Variables/ItemTemplate}}
						</div>
					</$list>
					<hr>
					<<dv-addNewVariableFilter>>
				</div>
			</div>
		</$linkcatcher>
	</$let>
</$reveal>
\end